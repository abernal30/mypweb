<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>8 Applied market anomalies. Momentum market anomalies | Algorithms and Financial Programming in R</title>
<meta name="author" content="Arturo Bernal">
<meta name="description" content="library(xts) library(dplyr) library(PerformanceAnalytics) library(quantmod) library(ggplot2)  8.1 Overview of the momentum market anomalies In chapter 7, we applied the EMH test for variance for...">
<meta name="generator" content="bookdown 0.30 with bs4_book()">
<meta property="og:title" content="8 Applied market anomalies. Momentum market anomalies | Algorithms and Financial Programming in R">
<meta property="og:type" content="book">
<meta property="og:url" content="https://www.arturo-bernal.com/book/applied-market-anomalies.-momentum-market-anomalies.html">
<meta property="og:image" content="https://www.arturo-bernal.com/book/images/coverf.png">
<meta property="og:description" content="library(xts) library(dplyr) library(PerformanceAnalytics) library(quantmod) library(ggplot2)  8.1 Overview of the momentum market anomalies In chapter 7, we applied the EMH test for variance for...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="8 Applied market anomalies. Momentum market anomalies | Algorithms and Financial Programming in R">
<meta name="twitter:description" content="library(xts) library(dplyr) library(PerformanceAnalytics) library(quantmod) library(ggplot2)  8.1 Overview of the momentum market anomalies In chapter 7, we applied the EMH test for variance for...">
<meta name="twitter:image" content="https://www.arturo-bernal.com/book/images/coverf.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/Roboto-0.4.2/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.4.1/transition.js"></script><script src="libs/bs3compat-0.4.1/tabs.js"></script><script src="libs/bs3compat-0.4.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68765210-2', 'auto');
      ga('send', 'pageview');

    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Algorithms and Financial Programming in R</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Algorithms and Financial Programming in R</a></li>
<li><a class="" href="preface.html">Preface</a></li>
<li><a class="" href="r-basics.html"><span class="header-section-number">1</span> R Basics</a></li>
<li><a class="" href="clean.html"><span class="header-section-number">2</span> Big data and data cleaning with datapro</a></li>
<li><a class="" href="graphs.html"><span class="header-section-number">3</span> APIS and R graphs</a></li>
<li><a class="" href="logit.html"><span class="header-section-number">4</span> Machine learning with market direction prediction: Logit</a></li>
<li><a class="" href="big-data-and-machine-learning.html"><span class="header-section-number">5</span> Big data and machine learning</a></li>
<li><a class="" href="credit-analysis.html"><span class="header-section-number">6</span> Credit analysis</a></li>
<li><a class="" href="rational-agent-and-behavioral-finance-in-investment.html"><span class="header-section-number">7</span> Rational agent and behavioral finance in investment</a></li>
<li><a class="active" href="applied-market-anomalies.-momentum-market-anomalies.html"><span class="header-section-number">8</span> Applied market anomalies. Momentum market anomalies</a></li>
<li><a class="" href="portfolio-management-algorithms.html"><span class="header-section-number">9</span> Portfolio management algorithms</a></li>
<li><a class="" href="references.html"><span class="header-section-number">10</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/abernal30/BookAFP">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="applied-market-anomalies.-momentum-market-anomalies" class="section level1" number="8">
<h1>
<span class="header-section-number">8</span> Applied market anomalies. Momentum market anomalies<a class="anchor" aria-label="anchor" href="#applied-market-anomalies.-momentum-market-anomalies"><i class="fas fa-link"></i></a>
</h1>
<div class="sourceCode" id="cb162"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/xts">xts</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/braverock/PerformanceAnalytics">PerformanceAnalytics</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.quantmod.com">quantmod</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div id="overview-of-the-momentum-market-anomalies" class="section level2" number="8.1">
<h2>
<span class="header-section-number">8.1</span> Overview of the momentum market anomalies<a class="anchor" aria-label="anchor" href="#overview-of-the-momentum-market-anomalies"><i class="fas fa-link"></i></a>
</h2>
<p>In chapter 7, we applied the EMH test for variance for many assets in building a portfolio. As you remember, we filter to get only those stocks for which the EMH fails, or the test suggests that it is an inefficient market, then we can make a prediction based on past information.</p>
<p>The final goal is to create a portfolio of filtered stocks and submit it to a trading platform, such as interactive brokers. For this chapter, we make another filter applying the momentum effect, which is a market anomaly. We follow the methodology of the article <span class="citation">(<a href="references.html#ref-momentum" role="doc-biblioref">Cervantes, Montoya, and Bernal 2016</a>)</span>.</p>
<p>Short run momentum (3 to 12 months). The strategy consists of buying assets when their prices are trending up and selling them when it is down. The idea is that the asset prices with previous higher returns (winners), in the short run, will continue to have high returns, and the asset prices with previous lower returns (losses) will continue to have lower returns. The strategy applyed to portfolio, consist of taking long positions in previous higher returns (winners), and short positions previous lower returns (losses) ones. When applied to portfolio, the strategy consists of taking long positions in previous higher returns (winners) and short ones in lower returns (losses).</p>
<p>Long run momentum or reversal effect (2 to 5 years). We expect the opposite effect in the long run. The reversal effect occurs when the asset prices with previous higher returns (winners) reverse and show lower returns. The asset prices with previous lower returns (losses) will have higher returns.</p>
<p>For this chapter, we will apply the Short run momentum strategy. We look for stocks for which we could apply trading strategies using historical information (that is why we made the EMH test). To reach that end, we will apply what is called algorithm trading. In this case, we will create a signal to buy(long position ) or sell (long position) based on variables created from past information. We will estimate the strategy return for each stock to filter those stocks that consistently show to be wines or losers.</p>
</div>
<div id="data-preparation-2" class="section level2" number="8.2">
<h2>
<span class="header-section-number">8.2</span> Data preparation<a class="anchor" aria-label="anchor" href="#data-preparation-2"><i class="fas fa-link"></i></a>
</h2>
<p>On Nov 11, we downloaded some tickers from the yahoo finance Screener, like this one:</p>
<div class="sourceCode" id="cb163"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="st">'images/yf.jpg'</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-2"></span>
<img src="images/yf.jpg" alt="..." width="80%"><p class="caption">
Figure 8.1: …
</p>
</div>
<p>As a result, we got the tickers and the prices and estimated the returns. In the next code, we import both the prices and the returns.</p>
<div class="sourceCode" id="cb164"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/xts">xts</a></span><span class="op">)</span></span>
<span><span class="co"># The Returns </span></span>
<span><span class="va">ret_o</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/abernal30/BookAFP/main/data/ret_momentum_orig.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># I deleted these two columns because they were causing errors in the code because of the missing values.</span></span>
<span><span class="va">del</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">17</span>,<span class="fl">117</span><span class="op">)</span></span>
<span><span class="va">ret_o</span><span class="op">&lt;-</span><span class="va">ret_o</span><span class="op">[</span><span class="op">-</span><span class="va">del</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># We will need also the original prices. </span></span>
<span><span class="va">price_o</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/abernal30/BookAFP/main/data/price_momentum_orig.csv"</span><span class="op">)</span></span>
<span><span class="va">price_o</span><span class="op">&lt;-</span><span class="va">price_o</span><span class="op">[</span><span class="op">-</span><span class="va">del</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">price_o</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;         Date SHOP.Close SQ.Close</span></span>
<span><span class="co">#&gt; 1 11/11/2019     30.332    63.79</span></span>
<span><span class="co">#&gt; 2 11/12/2019     30.556    61.54</span></span>
<span><span class="co">#&gt; 3 11/13/2019     31.431    61.51</span></span>
<span><span class="co">#&gt; 4 11/14/2019     31.245    62.99</span></span>
<span><span class="co">#&gt; 5 11/15/2019     31.238    64.70</span></span>
<span><span class="co">#&gt; 6 11/18/2019     32.298    65.74</span></span></code></pre></div>
<p>The following are to transform the data frame date into xts.</p>
<div class="sourceCode" id="cb165"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#  Instead of doing the procedure twice, we create function, call it my_xts, that transform into xts a data frame that has as first column the date.</span></span>
<span></span>
<span><span class="va">my_xts</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">data</span>,<span class="va">date_format</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">date</span><span class="op">&lt;-</span><span class="va">data</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">datax</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xts/man/xts.html">xts</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>              order.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="va">date</span>,<span class="va">date_format</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">datax</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#-------- ends here---------</span></span>
<span></span>
<span></span>
<span><span class="co">#---- Here we apply the function</span></span>
<span></span>
<span><span class="co"># You need to look at the date format, Example: "%Y-%m-%d" "%y/%m/%d",  Y for 4 digits year</span></span>
<span><span class="co">#  (y for 2 digits), m for month and d for day.</span></span>
<span>  </span>
<span><span class="co"># In the previous chunk we can see that the date format is %m/%d/%Y</span></span>
<span></span>
<span><span class="co"># Here we use the function </span></span>
<span><span class="va">price_xts</span><span class="op">&lt;-</span><span class="fu">my_xts</span><span class="op">(</span><span class="va">price_o</span>,<span class="st">"%m/%d/%Y"</span><span class="op">)</span></span>
<span><span class="va">ret_xts</span><span class="op">&lt;-</span><span class="fu">my_xts</span><span class="op">(</span><span class="va">ret_o</span>,<span class="st">"%m/%d/%Y"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">ret_xts</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;              SHOP.Close     SQ.Close     SE.Close</span></span>
<span><span class="co">#&gt; 2019-11-12  0.007384907 -0.035271986  0.185806387</span></span>
<span><span class="co">#&gt; 2019-11-13  0.028635947 -0.000487537 -0.042981450</span></span>
<span><span class="co">#&gt; 2019-11-14 -0.005917693  0.024061194  0.049459864</span></span>
<span><span class="co">#&gt; 2019-11-15 -0.000224036  0.027147086 -0.014626138</span></span>
<span><span class="co">#&gt; 2019-11-18  0.033932997  0.016074205  0.006871907</span></span>
<span><span class="co">#&gt; 2019-11-19 -0.020744319  0.009583283  0.010373928</span></span></code></pre></div>
<p>We want apply a short momentum strategy of 30 days. In other words, we want to verify if, for the winners assess, we can buy the stock, and make a profit 30 days after, because we expect that the stock price will be increasing. For example, suppose the algorithm generates a buy signal, the strategy would imply to buy the stock today, and sell it 30 days after.</p>
</div>
<div id="signal-creation-for-one-stock" class="section level2" number="8.3">
<h2>
<span class="header-section-number">8.3</span> Signal creation for one stock<a class="anchor" aria-label="anchor" href="#signal-creation-for-one-stock"><i class="fas fa-link"></i></a>
</h2>
<p>For exposition proposes, we start by applying the strategy on the first stock of our data set, in subsequent section we apply a code for making the procedure for all the stocks in the data set.</p>
<p>To create the signal, we follow the book <span class="citation">(<a href="references.html#ref-jeet" role="doc-biblioref">Jeet and Vats 2017</a>)</span>. The idea is to combining two technical analysis indicators, the Moving Average Converge Diverge (MACD) and Bollinger Bands (BB) (see the Appendix).</p>
<p>Firts we create the MACD and plot a few observations.</p>
<div class="sourceCode" id="cb166"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">macd</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/TTR/man/MACD.html">MACD</a></span><span class="op">(</span><span class="va">price_xts</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> , nFast <span class="op">=</span> <span class="fl">12</span>  , nSlow <span class="op">=</span><span class="fl">26</span> , nSig <span class="op">=</span> <span class="fl">9</span>, maType<span class="op">=</span><span class="st">"SMA"</span><span class="op">)</span></span></code></pre></div>
<p>We use the ggplot library for making the graph.</p>
<div class="sourceCode" id="cb167"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span><span class="op">&lt;-</span><span class="va">macd</span> </span>
<span><span class="va">macd_df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span><span class="fl">30</span><span class="op">:</span><span class="fl">100</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">date</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">macd_df</span><span class="op">)</span>,format <span class="op">=</span> <span class="st">"%Y-%m-%d"</span><span class="op">)</span></span>
<span><span class="va">macd_df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">date</span>,<span class="va">macd_df</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">macd_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">macd</span>, colour <span class="op">=</span><span class="st">"macd"</span>, col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">signal</span>,colour<span class="op">=</span><span class="st">"signal"</span>,col<span class="op">=</span><span class="st">"red"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-Momentum-or-directional-trading-II_files/figure-html/unnamed-chunk-7-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>Regarding the MACD, usually traders may buy the security when the MACD (red) crosses above its signal line (blue) and sell - or short - the security when the MACD (red) crosses below the signal line (blue).</p>
<p>The <strong>Bollinger Bands</strong> are also a technical analysis indicator.</p>
<div class="sourceCode" id="cb168"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bb</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/TTR/man/bollingerBands.html">BBands</a></span><span class="op">(</span><span class="va">price_xts</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> , n <span class="op">=</span> <span class="fl">20</span>, maType<span class="op">=</span><span class="st">"SMA"</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">bb</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">bb</span>,<span class="va">price_xts</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bb_df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">bb</span><span class="op">[</span><span class="fl">30</span><span class="op">:</span><span class="fl">100</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">date</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">bb_df</span><span class="op">)</span>,format <span class="op">=</span> <span class="st">"%Y-%m-%d"</span><span class="op">)</span></span>
<span><span class="va">bb_df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">date</span>,<span class="va">bb_df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">bb_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">dn</span>, colour <span class="op">=</span><span class="st">"bands"</span>,col<span class="op">=</span><span class="va">col2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">up</span>, colour <span class="op">=</span><span class="st">"bands"</span>,col<span class="op">=</span><span class="va">col2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span><span class="va">SHOP.Close</span> ,colour<span class="op">=</span><span class="st">"SHOP.Close"</span>,col<span class="op">=</span><span class="va">col1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-Momentum-or-directional-trading-II_files/figure-html/unnamed-chunk-8-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>In the BB case, usually traders consider that when the price (blue) continually touches the upper Bollinger Band (red), it can indicate an overbought signal, while continually touching the lower band (red) indicates an oversold signal.</p>
<p>We now combine the indicators to create the signal in the following way: when the price is higher than the “up” band, and the macd is higher than its signal is a buy signal (1). When the price is lower than the “dn” band, and the macd is lower than its signal is a sell, or short sale, signal (-1). Other wise a neutral signal, or doing nothing (0).</p>
<div class="sourceCode" id="cb169"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span><span class="op">&lt;-</span><span class="fl">1</span> <span class="co"># This is because we are aplying the signal on the first stock, column</span></span>
<span></span>
<span><span class="va">data</span><span class="op">&lt;-</span><span class="va">price_xts</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span></span>
<span><span class="va">signal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">data</span> <span class="op">&gt;</span> <span class="va">bb</span><span class="op">[</span>,<span class="st">'up'</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">macd</span><span class="op">[</span>,<span class="st">'macd'</span><span class="op">]</span> <span class="op">&gt;</span><span class="va">macd</span><span class="op">[</span>,<span class="st">'signal'</span><span class="op">]</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">&lt;</span> <span class="va">bb</span><span class="op">[</span>,<span class="st">'dn'</span><span class="op">]</span> <span class="op">&amp;</span><span class="va">macd</span><span class="op">[</span>,<span class="st">'macd'</span><span class="op">]</span> <span class="op">&lt;</span><span class="va">macd</span><span class="op">[</span>,<span class="st">'signal'</span><span class="op">]</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">signal_df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">signal</span><span class="op">[</span><span class="fl">30</span><span class="op">:</span><span class="fl">100</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="va">date</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">signal_df</span><span class="op">)</span>,format <span class="op">=</span> <span class="st">"%Y-%m-%d"</span><span class="op">)</span></span>
<span><span class="va">signal_df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">date</span>,<span class="va">signal_df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">signal_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span><span class="va">SHOP.Close</span>, colour<span class="op">=</span><span class="va">SHOP.Close</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-Momentum-or-directional-trading-II_files/figure-html/unnamed-chunk-9-1.png" width="90%" style="display: block; margin: auto;"></div>
</div>
<div id="back-testing" class="section level2" number="8.4">
<h2>
<span class="header-section-number">8.4</span> Back testing<a class="anchor" aria-label="anchor" href="#back-testing"><i class="fas fa-link"></i></a>
</h2>
<p>To back-test the momentum strategy, we have to divide the data set into training and testing, for example, as in machine learning. In <span class="citation">(<a href="references.html#ref-jeet" role="doc-biblioref">Jeet and Vats 2017</a>)</span>, they call it in_sample and out_sample.</p>
<p>Remember that we want to verify the strategy return 30 days after we buy (sell) the stock. To prove that, we have two alternatives:</p>
<p>Alternative 1: Wait in time, 30 days, to verify if the strategy works or not; if it does not work, then we have to calibrate the strategy and prove it again, waiting another 30 days and so on.</p>
<p>Alternative 2 (The one we will apply): Assuming that we still don’t know what happened in the last 30 days. We can test our strategy and compare it with what happens in those 30 days. If it does not work, we must calibrate the strategy before.</p>
<p>In total, we are creating a 90 days window for this case. The training sample will be a 60 days window, 90 days before the date of the last price known and 60 days after that day. The test sample will also be in a 60 days window, 60 days before the date of the last price known.</p>
<p>In the following figure, we explain why.</p>
<div class="sourceCode" id="cb170"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="st">'images/grap1.jpg'</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:unnamed-chunk-10"></span>
<img src="images/grap1.jpg" alt="..." width="80%"><p class="caption">
Figure 8.2: …
</p>
</div>
<p>Regarding the 60 days windows of the training sample, the strategy involves estimating moving averages of 26 days; then, we need a window period for that estimation and a 30-day window for creating the signals.</p>
<p>Regarding the test sample, suppose our algorithm generates a signal like the green or orange dots. The backtesting implies estimating the return 30 days after. If we do not know the 30-day last price, we may have to wait a few days or almost a month to verify our strategy return. Finally, the test set is a 60 days window because, in the finale stage, we will compare the return in this window with the return of the train set window to verify the consistency and make a filter.</p>
<div class="sourceCode" id="cb171"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dim</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">price_xts</span><span class="op">)</span> <span class="co">#dimension</span></span>
<span><span class="va">dim_ret</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">ret_xts</span><span class="op">)</span></span>
<span><span class="va">momen_days</span><span class="op">&lt;-</span> <span class="fl">30</span> <span class="co"># This is the period  of the momentum strategy</span></span>
<span><span class="co">#days&lt;-momen_days*2</span></span>
<span></span>
<span><span class="co"># momen_days in this case a 90 days window</span></span>
<span><span class="va">start_train</span><span class="op">&lt;-</span><span class="va">dim</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="va">momen_days</span><span class="op">*</span><span class="fl">3</span></span>
<span></span>
<span><span class="co"># in this case 60 days after strat train</span></span>
<span><span class="va">end_train</span><span class="op">&lt;-</span><span class="va">start_train</span><span class="op">+</span><span class="va">momen_days</span><span class="op">*</span><span class="fl">2</span></span>
<span></span>
<span><span class="co"># in this case 30 days after strat train</span></span>
<span><span class="va">start_test</span><span class="op">&lt;-</span><span class="va">start_train</span><span class="op">+</span><span class="va">momen_days</span></span>
<span></span>
<span><span class="co"># the most current price</span></span>
<span><span class="va">end_test</span><span class="op">&lt;-</span><span class="va">dim_ret</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="va">price_train</span><span class="op">&lt;-</span><span class="va">price_xts</span><span class="op">[</span><span class="va">start_train</span><span class="op">:</span><span class="va">end_train</span>,<span class="op">]</span> <span class="co">#cinitial date</span></span>
<span><span class="va">price_test</span><span class="op">&lt;-</span><span class="va">price_xts</span><span class="op">[</span><span class="va">start_test</span><span class="op">:</span><span class="va">end_test</span>,<span class="op">]</span> <span class="co">#cinitial date</span></span>
<span></span>
<span></span>
<span><span class="va">ret_train</span><span class="op">&lt;-</span><span class="va">ret_xts</span><span class="op">[</span><span class="va">start_train</span><span class="op">:</span><span class="va">end_train</span>,<span class="op">]</span> <span class="co">#cinitial date</span></span>
<span><span class="va">ret_test</span><span class="op">&lt;-</span><span class="va">ret_xts</span><span class="op">[</span><span class="va">start_test</span><span class="op">:</span><span class="va">end_test</span>,<span class="op">]</span> <span class="co">#cinitial date</span></span></code></pre></div>
<p>We need to create again the signal on the price_train data set, this time for the column 5.</p>
<div class="sourceCode" id="cb172"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span><span class="op">&lt;-</span><span class="fl">5</span> <span class="co"># Is column number that we can change</span></span>
<span></span>
<span><span class="va">macd</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/TTR/man/MACD.html">MACD</a></span><span class="op">(</span><span class="va">price_train</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> , nFast <span class="op">=</span><span class="fl">12</span>  , nSlow <span class="op">=</span><span class="fl">26</span> , nSig <span class="op">=</span> <span class="fl">9</span>, maType<span class="op">=</span><span class="st">"SMA"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">bb</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/TTR/man/bollingerBands.html">BBands</a></span><span class="op">(</span><span class="va">price_train</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, n <span class="op">=</span> <span class="fl">20</span>, maType<span class="op">=</span><span class="st">"SMA"</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">signal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">price_train</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">&gt;</span> <span class="va">bb</span><span class="op">[</span>,<span class="st">'up'</span><span class="op">]</span> <span class="op">&amp;</span> <span class="va">macd</span><span class="op">[</span>,<span class="st">'macd'</span><span class="op">]</span> <span class="op">&gt;</span><span class="va">macd</span><span class="op">[</span>,<span class="st">'signal'</span><span class="op">]</span>,<span class="fl">1</span>,<span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">price_train</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">&lt;</span> <span class="va">bb</span><span class="op">[</span>,<span class="st">'dn'</span><span class="op">]</span> <span class="op">&amp;</span><span class="va">macd</span><span class="op">[</span>,<span class="st">'macd'</span><span class="op">]</span> <span class="op">&lt;</span><span class="va">macd</span><span class="op">[</span>,<span class="st">'signal'</span><span class="op">]</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">signal_df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span></span>
<span></span>
<span><span class="va">date</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">signal_df</span><span class="op">)</span>,format <span class="op">=</span> <span class="st">"%Y-%m-%d"</span><span class="op">)</span></span>
<span><span class="va">signal_df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">date</span>,<span class="va">signal_df</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">signal_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span><span class="va">NIO.Close</span>, colour<span class="op">=</span><span class="va">NIO.Close</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="08-Momentum-or-directional-trading-II_files/figure-html/unnamed-chunk-12-1.png" width="90%" style="display: block; margin: auto;"></div>
<p>o estimate our strategy return, we need to verify what happens 30 days after we buy(sell) the asset (30 days is because it is a 30 days momentum strategy). Then we need to take the price of the day of buy (sale) in the training data set and the price 30 days after in the test data set.</p>
<p>We will search in the signal object and gets only the buying (1) or sale (-1) signals, and stores the dates of the signal, moment_days (30 in this case), days after, and the return. For example, in row 44 there is a sell signal.</p>
<div class="sourceCode" id="cb173"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">signal</span><span class="op">[</span><span class="fl">44</span>,<span class="fl">1</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt;            NIO.Close</span></span>
<span><span class="co">#&gt; 2022-09-02        -1</span></span></code></pre></div>
<p>For this case, the day of the signal is 2022-09-02. The next code creates a data frame to store that date, the signal, and a date 30 days after that signal.</p>
<div class="sourceCode" id="cb174"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>sig_data<span class="op">=</span><span class="st">"2022-09-02"</span>,signal<span class="op">=</span><span class="va">signal</span><span class="op">[</span><span class="fl">44</span>,<span class="fl">1</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, sig_data_30_after<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="st">"2022-09-02"</span><span class="op">)</span><span class="op">+</span><span class="fl">30</span>,return<span class="op">=</span><span class="cn">NA</span>,ticker<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"Signal"</span></span>
<span><span class="va">df</span></span>
<span><span class="co">#&gt;              sig_data Signal sig_data_30_after return    ticker</span></span>
<span><span class="co">#&gt; 2022-09-02 2022-09-02     -1        2022-10-02     NA NIO.Close</span></span></code></pre></div>
<p>For the moment we let the return column empty, an NA.</p>
<p>Now we estimate the return of this particular signal. We estimate the annualized geometric return:</p>
<p><span class="math display">\[ geometric\ return =\prod_{i=1}^{n} (1+HPR)^{scale/n}\]</span></p>
<p>where <span class="math inline">\(\prod_{i=1}^{n} (1+HPR)\)</span> is the product of (1+HPR). Also, n is the number of observations, scale is number of periods in a year (daily scale = 252, monthly scale = 12, quarterly scale = 4) and HPR is the Holding Period Return:</p>
<p><span class="math display">\[HPR=  \frac{Price_{t} - Price_{t-1}}{Price_{t-1}}\]</span></p>
<p>First, we make a sample window from 2022-09-02 to 2022-10-02.</p>
<div class="sourceCode" id="cb175"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">sub_price_test</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/window.html">window</a></span><span class="op">(</span><span class="va">price_test</span> <span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, start <span class="op">=</span><span class="va">df</span><span class="op">[</span>,<span class="st">"sig_data"</span><span class="op">]</span>, end <span class="op">=</span> <span class="va">df</span><span class="op">[</span>,<span class="st">"sig_data_30_after"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sub_price_test</span><span class="op">)</span></span>
<span><span class="co">#&gt;            NIO.Close</span></span>
<span><span class="co">#&gt; 2022-09-02     17.73</span></span>
<span><span class="co">#&gt; 2022-09-06     17.11</span></span>
<span><span class="co">#&gt; 2022-09-07     17.48</span></span>
<span><span class="co">#&gt; 2022-09-08     17.68</span></span>
<span><span class="co">#&gt; 2022-09-09     19.16</span></span>
<span><span class="co">#&gt; 2022-09-12     21.75</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">sub_price_test</span><span class="op">)</span></span>
<span><span class="co">#&gt;            NIO.Close</span></span>
<span><span class="co">#&gt; 2022-09-23     17.64</span></span>
<span><span class="co">#&gt; 2022-09-26     17.62</span></span>
<span><span class="co">#&gt; 2022-09-27     17.19</span></span>
<span><span class="co">#&gt; 2022-09-28     17.33</span></span>
<span><span class="co">#&gt; 2022-09-29     15.58</span></span>
<span><span class="co">#&gt; 2022-09-30     15.77</span></span></code></pre></div>
<p>Now we estimate the arithmetic return on that sum sample, and apply the Return.annualized function.</p>
<div class="sourceCode" id="cb176"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sub_ret</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/quantmod/man/Delt.html">Delt</a></span><span class="op">(</span><span class="va">sub_price_test</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">reti</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/PerformanceAnalytics/man/Return.annualized.html">Return.annualized</a></span><span class="op">(</span><span class="va">sub_ret</span>,geometric <span class="op">=</span> <span class="cn">T</span>,scale<span class="op">=</span> <span class="fl">252</span><span class="op">)</span></span>
<span><span class="va">reti</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] -0.788549</span></span></code></pre></div>
<div class="sourceCode" id="cb177"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span><span class="op">[</span>,<span class="st">"return"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">reti</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">df</span><span class="op">[</span>,<span class="st">"Signal"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span><span class="op">&lt;-</span><span class="st">"return"</span></span>
<span><span class="va">df</span></span>
<span><span class="co">#&gt;              sig_data Signal sig_data_30_after   return    ticker</span></span>
<span><span class="co">#&gt; 2022-09-02 2022-09-02     -1        2022-10-02 0.788549 NIO.Close</span></span></code></pre></div>
<p>The next code does the same procedure for all the signals of the stock we are analyzing.</p>
<div class="sourceCode" id="cb178"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remember that in an R function, you do not need to change the content of the function; only use it. Except if you have the knowledge to do it, which we do not expect in this course</span></span>
<span></span>
<span><span class="co">#-------Do not change from her-----------</span></span>
<span></span>
<span><span class="co"># This function has only one argument, a data frame with the signals we created in the previous chunk. It searches on the signal object and gets only for buying (1) or sale (-1) signals, and stores the dates of the signal, and moment_days (30 in this case) days after. </span></span>
<span></span>
<span><span class="va">strat_results</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">signal</span>,<span class="va">data</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">signal_na</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span></span>
<span>  <span class="va">sig_date</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">sig_sig</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">tick</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">signal</span><span class="op">)</span></span>
<span>  </span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">signal_na</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">signal_na</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">==</span><span class="fl">1</span> <span class="op">|</span> <span class="va">signal_na</span><span class="op">[</span><span class="va">i</span>,<span class="fl">1</span><span class="op">]</span><span class="op">==</span> <span class="op">-</span><span class="fl">1</span> <span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">sig_date</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sig_date</span>,<span class="fu"><a href="https://rdrr.io/pkg/zoo/man/index.html">index</a></span><span class="op">(</span><span class="va">signal_na</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">sig_sig</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">sig_sig</span>,<span class="va">signal_na</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ma</span><span class="op">&lt;-</span></span>
<span><span class="va">le2</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">sig_date</span><span class="op">)</span></span>
<span><span class="va">ma</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,<span class="va">le2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res_signal0</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>sig_date<span class="op">=</span><span class="va">sig_date</span>,sig_sig<span class="op">=</span><span class="va">sig_sig</span>,momen_days_sig<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">le2</span><span class="op">)</span>,strat_ret<span class="op">=</span><span class="va">ma</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>,ticker<span class="op">=</span><span class="va">tick</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res_signal0</span><span class="op">[</span>,<span class="st">"momen_days_sig"</span><span class="op">]</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/yearmon.html">as.Date</a></span><span class="op">(</span><span class="va">res_signal0</span><span class="op">[</span>,<span class="st">"sig_date"</span><span class="op">]</span><span class="op">+</span><span class="va">momen_days</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#res_signal0&lt;-mr</span></span>
<span><span class="va">di</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">res_signal0</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">iz</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">di</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span><span class="va">sub</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/window.html">window</a></span><span class="op">(</span><span class="va">data</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>, start <span class="op">=</span><span class="va">res_signal0</span><span class="op">[</span><span class="va">iz</span>,<span class="st">"sig_date"</span><span class="op">]</span>, end <span class="op">=</span> <span class="va">res_signal0</span><span class="op">[</span><span class="va">iz</span>,<span class="st">"momen_days_sig"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">sub_ret</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/quantmod/man/Delt.html">Delt</a></span><span class="op">(</span><span class="va">sub</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ret_annual</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/PerformanceAnalytics/man/Return.annualized.html">Return.annualized</a></span><span class="op">(</span><span class="va">sub_ret</span>,geometric <span class="op">=</span> <span class="cn">T</span>,scale<span class="op">=</span> <span class="fl">252</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res_signal0</span><span class="op">[</span><span class="va">iz</span>,<span class="st">"strat_ret"</span><span class="op">]</span><span class="op">&lt;-</span><span class="va">ret_annual</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">*</span><span class="va">res_signal0</span><span class="op">[</span><span class="va">iz</span>,<span class="st">"sig_sig"</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span><span class="va">res_signal0</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mr</span><span class="op">&lt;-</span><span class="fu">strat_results</span><span class="op">(</span><span class="va">signal</span>, <span class="va">price_test</span><span class="op">)</span></span>
<span><span class="va">mr</span></span>
<span><span class="co">#&gt;     sig_date sig_sig momen_days_sig   strat_ret    ticker</span></span>
<span><span class="co">#&gt; 1 2022-08-23      -1     2022-09-22  0.95452790 NIO.Close</span></span>
<span><span class="co">#&gt; 2 2022-09-02      -1     2022-10-02  0.78848347 NIO.Close</span></span>
<span><span class="co">#&gt; 3 2022-09-06      -1     2022-10-06 -0.02053551 NIO.Close</span></span>
<span><span class="co">#&gt; 4 2022-09-13       1     2022-10-13 -0.58211173 NIO.Close</span></span></code></pre></div>
</div>
<div id="appendix-1" class="section level2" number="8.5">
<h2>
<span class="header-section-number">8.5</span> Appendix<a class="anchor" aria-label="anchor" href="#appendix-1"><i class="fas fa-link"></i></a>
</h2>
<div id="the-macd-and-signals-from-investopedia." class="section level3" number="8.5.1">
<h3>
<span class="header-section-number">8.5.1</span> The MACD and signals (from investopedia).<a class="anchor" aria-label="anchor" href="#the-macd-and-signals-from-investopedia."><i class="fas fa-link"></i></a>
</h3>
<p>Moving Average Convergence Divergence (MACD) is a trend-following momentum indicator that shows the relationship between two moving averages of a security’s price. The MACD is calculated by subtracting the 26-period Exponential Moving Average (EMA) from the 12-period EMA.</p>
<p>The result of that calculation is the MACD line. A nine-day EMA of the MACD called the “signal line,” is then plotted with the MACD line, which can be a signal for buy and sell. Traders may buy the security when the MACD crosses above its signal line and sell - or short - the security when the MACD crosses below the signal line.</p>
<p>An exponential moving average (EMA) is a type of moving average (MA) that places a greater weight and significance on the most recent data points. The exponential moving average is also referred to as the exponentially weighted moving average. An exponentially weighted moving average reacts more significantly to recent price changes than a simple moving average (SMA), which applies an equal weight to all observations in the period.</p>
<p>In the next example, by default, the function MACD creates a 12 days EMA and 26-days EMA.</p>
</div>
<div id="the-bollinger-bands-from-investopedia" class="section level3" number="8.5.2">
<h3>
<span class="header-section-number">8.5.2</span> The Bollinger Bands (from investopedia)<a class="anchor" aria-label="anchor" href="#the-bollinger-bands-from-investopedia"><i class="fas fa-link"></i></a>
</h3>
<p>Are a technical analysis tool developed by John Bollinger for generating oversold or overbought signals.</p>
<p>There are three lines that compose Bollinger Bands: A simple moving average (middle band) and an upper and lower band.</p>
<p>The upper and lower bands are typically 2 standard deviations +/- from a 20-day simple moving average (which is the center line), but they can be modified.</p>
<p>When the price continually touches the upper Bollinger Band, it can indicate an overbought signal while continually touching the lower band indicates an oversold signal.</p>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="rational-agent-and-behavioral-finance-in-investment.html"><span class="header-section-number">7</span> Rational agent and behavioral finance in investment</a></div>
<div class="next"><a href="portfolio-management-algorithms.html"><span class="header-section-number">9</span> Portfolio management algorithms</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#applied-market-anomalies.-momentum-market-anomalies"><span class="header-section-number">8</span> Applied market anomalies. Momentum market anomalies</a></li>
<li><a class="nav-link" href="#overview-of-the-momentum-market-anomalies"><span class="header-section-number">8.1</span> Overview of the momentum market anomalies</a></li>
<li><a class="nav-link" href="#data-preparation-2"><span class="header-section-number">8.2</span> Data preparation</a></li>
<li><a class="nav-link" href="#signal-creation-for-one-stock"><span class="header-section-number">8.3</span> Signal creation for one stock</a></li>
<li><a class="nav-link" href="#back-testing"><span class="header-section-number">8.4</span> Back testing</a></li>
<li>
<a class="nav-link" href="#appendix-1"><span class="header-section-number">8.5</span> Appendix</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#the-macd-and-signals-from-investopedia."><span class="header-section-number">8.5.1</span> The MACD and signals (from investopedia).</a></li>
<li><a class="nav-link" href="#the-bollinger-bands-from-investopedia"><span class="header-section-number">8.5.2</span> The Bollinger Bands (from investopedia)</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/abernal30/BookAFP/blob/master/08-Momentum-or-directional-trading-II.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/abernal30/BookAFP/edit/master/08-Momentum-or-directional-trading-II.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Algorithms and Financial Programming in R</strong>" was written by Arturo Bernal. It was last built on 2023-02-11.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
